# 更新日志

## [2.0.4] - 2025-10-16

### 🐛 Bug修复
- **修复数据库字段定义缺失**
  - 添加 `usernameLastChecked` 和 `usernameCheckFailCount` 到数据库模型定义
  - 解决 v2.0.3 运行时报错 "unknown field in model mcidbind" 的问题
  - 确保改名检测缓存机制正常工作

### ⚡ 性能优化
- **查询命令响应速度优化**
  - `mcid query` 命令中的群昵称设置改为异步执行
  - 查询结果立即返回，不再被群昵称设置操作阻塞
  - 群昵称设置在后台异步完成，失败不影响查询响应
  - 提升用户体验，减少查询等待时间

### 🔧 技术改进
- **智能异步任务处理**
  - 区分需要同步执行和可异步执行的群昵称设置场景
  - 查询操作：异步设置，不阻塞响应
  - 绑定操作：同步设置，确保流程完整
  - 随机提醒：同步设置，保证逻辑正确

## [2.0.0] - 2025-10-14

### 🎉 重大更新 - BIND-BOT 诞生

#### 📦 项目重构
- **项目更名**: `koishi-plugin-mcid-bot` → `koishi-plugin-bind-bot`
- **插件ID**: `mcid-bot` → `bind-bot`
- **新仓库**: https://github.com/WittF/bind-bot
- **许可证变更**: MIT → CC BY-NC-SA 4.0（禁止商业使用）

#### 🏗️ 架构革命 - 模块化重构
- **代码优化**: 主文件从 7116 行减少到 3187 行（-55%）
- **架构模式**: 采用 Handler + Repository + Dependency Injection 模式
- **模块总数**: 20+ 个独立模块，职责清晰

**新增目录结构**:
```
src/
├── handlers/          # 命令处理器层 (6个)
│   ├── base.handler.ts
│   ├── mcid.handler.ts
│   ├── buid.handler.ts
│   ├── whitelist.handler.ts
│   ├── tag.handler.ts
│   └── binding.handler.ts
├── repositories/      # 数据访问层 (2个)
│   ├── mcidbind.repository.ts
│   └── schedule-mute.repository.ts
├── managers/          # 管理器层 (1个)
│   └── rcon-manager.ts
├── utils/             # 工具层 (5个)
│   ├── logger.ts
│   ├── helpers.ts
│   ├── session-manager.ts
│   ├── message-utils.ts
│   └── rate-limiter.ts
├── types/             # 类型定义层 (5个)
│   ├── config.ts
│   ├── database.ts
│   ├── api.ts
│   ├── common.ts
│   └── index.ts
├── force-bind-utils.ts
├── export-utils.ts
└── index.ts           # 主入口 (3187行)
```

#### 🎯 Handler 层 (命令处理器)
- **BaseHandler**: 抽象基类，统一依赖注入接口
- **McidCommandHandler** (1274行): MC 账号管理的所有命令
- **BuidHandler** (791行): B站账号管理命令
- **WhitelistHandler** (1165行): 白名单管理命令
- **TagHandler** (372行): 用户标签系统
- **BindingHandler** (343行): 交互式绑定流程

#### 💾 Repository 层 (数据仓储)
- **MCIDBINDRepository**: 封装所有 MCIDBIND 表操作
  - 15个方法: 查询(6)、修改(5)、专用(4)
  - 类型安全的 CRUD 接口
- **ScheduleMuteRepository**: 定时禁言任务管理
  - 完整的任务 CRUD 和状态控制

#### 🛠️ Utils 层 (工具模块)
- **LoggerService**: 统一日志服务，支持调试模式和上下文标签
- **Helpers**: 11个纯函数工具（QQ号规范化、UUID格式化、冷却检查等）
- **SessionManager**: 交互式绑定会话管理，自动超时清理
- **MessageUtils**: 消息发送/撤回、群昵称管理
- **RateLimiter**: 请求频率限制器

#### 🎭 Managers 层
- **RconManager**: RCON 连接池管理
  - 连接复用和心跳保持（5分钟）
  - 自动重连机制
  - 空闲连接清理（30分钟）
  - 最大连接数限制（20个）

#### 📐 Types 层 (类型系统)
- **统一类型定义**: 消除 6 处重复类型定义
- **config.ts**: Config, ServerConfig, ForceBindConfig
- **database.ts**: MCIDBIND, SCHEDULE_MUTE_TASKS
- **api.ts**: Mojang, Zminfo, Bilibili API 类型
- **common.ts**: AvatarCache, BindingSession, LotteryResult
- **单一数据源**: 所有模块从 `types/` 导入类型

#### 🔧 功能模块
- **ForceBinder**: B站强制绑定，使用 B站 Live API
- **GroupExporter**: 群成员数据导出为 Excel

#### 🎨 架构优势
- ✅ **单一职责**: 每个模块专注于一个功能领域
- ✅ **依赖注入**: 通过构造函数注入，易于测试和替换
- ✅ **Repository Pattern**: 数据访问与业务逻辑分离
- ✅ **类型安全**: 充分利用 TypeScript 类型系统
- ✅ **易于维护**: 修改局部不影响全局
- ✅ **易于扩展**: 添加新功能只需创建新 Handler
- ✅ **向后兼容**: 主文件保留包装函数

#### 📚 文档完善
- **CLAUDE.md**: 688 行完整开发文档
  - 项目概述和架构说明
  - 所有模块的详细介绍
  - 使用示例和最佳实践
  - 维护和扩展指南
- **LICENSE**: CC BY-NC-SA 4.0 双语许可证文件
- **readme.md**: 更新项目名称和描述
- **.npmignore**: 优化发布内容，过滤开发文件

#### 🔄 迁移说明
- **npm 包名变更**: 用户需要卸载旧包 `koishi-plugin-mcid-bot`，安装新包 `koishi-plugin-bind-bot`
- **配置兼容**: 所有配置项保持不变，无需修改
- **功能保持**: 所有现有功能完全保留，无破坏性变更
- **数据库兼容**: 数据表结构未变，无需迁移数据

#### 📊 统计数据
- **删除代码**: 9536 行（旧服务和容器架构）
- **新增代码**: 7256 行（模块化架构）
- **净优化**: 主文件减少 3929 行（-55%）
- **模块数量**: 从 1 个巨文件变为 20+ 个独立模块
- **文件总数**: 40 个文件发生变更

---

## [1.3.7]

### 🐛 重要Bug修复
- **修复新人绑定流程显示问题**
  - 修复当用户MC为临时用户名时，新人绑定错误显示"🎮 已绑定MC: 未绑定"的问题
  - 正确识别用户实际只绑定了B站账号的状态，显示适当的绑定提醒
  - 新增对临时用户名的特殊处理逻辑，避免混淆用户

- **修复管理员绑定流程监控错误**
  - 修复管理员为其他用户启动绑定流程时，系统监控错误用户的严重问题
  - 统一 `createBindingSession` 和 `getBindingSession` 中的用户ID处理逻辑
  - 确保绑定会话正确绑定到目标用户，而非管理员自己

### 🆕 功能改进
- **增强mcid query查询功能**
  - 当用户没有绑定MC账号但绑定了B站账号时，不再只显示"未绑定MC账号"
  - 完整显示B站账号信息，包括UID、用户名、舰长等级、粉丝牌等详细信息
  - 提供绑定MC账号的操作提示，改善用户体验

- **优化新人绑定流程逻辑**
  - 更精确的绑定状态判断，正确区分各种绑定组合状态
  - 针对不同绑定状态提供更合适的操作指引
  - 避免为已完成绑定的用户重复显示绑定提醒


## [1.3.5]

- **修复群昵称设置API调用问题**
  - 修复OneBot API `getGroupMemberInfo` 和 `setGroupCard` 的参数格式错误
  - 将带平台前缀的用户ID（如`onebot:3431185320`）改为纯数字格式（`3431185320`）
  - 解决 retcode: 1200 错误，确保群昵称功能正常工作

  ### 🔧 技术改进
- **统一会话管理机制**
  - 修复绑定会话键值不一致导致的管理员功能失效
  - 统一使用 `normalizeQQId` 处理所有用户ID
  - 提高代码的一致性和可维护性

## [1.3.4]

### 🆕 新增功能
- **交互式绑定支持@Bot输入**
  - 用户现在可以在交互式绑定流程中使用 `@Bot 123123` 的形式发送MC用户名或B站UID
  - 系统会自动识别并清理@Bot前缀，提取实际的用户输入内容
  - 支持多种@Bot格式：`<at id="botUserId"/>`、`@Bot昵称`、`@botUserId`

### 🔧 用户体验优化
- **智能输入识别**
  - 新增 `cleanUserInput` 函数，智能清理用户输入中的@Bot前缀
  - 避免命令误判：命令检测使用原始内容，实际绑定使用清理后的内容
  - 提供调试日志显示输入清理过程，便于排查问题

- **更自然的交互方式**
  - 用户可以更自然地使用@Bot进行交互，符合QQ使用习惯
  - 支持用户在绑定过程中习惯性地@Bot发送内容
  - 保持与其他命令一致的交互体验

## [1.3.3]

### 🐛 重要Bug修复
- **修复mcid query显示逻辑**
  - 修复当用户没有绑定MC账号但绑定了B站账号时，只显示"该用户尚未绑定MC账号"，不显示B站信息的问题
  - 现在会在显示"该用户尚未绑定MC账号"的同时，下方完整显示B站账号信息（UID、用户名、舰长等级、粉丝牌等）

- **修复buid query显示格式问题**
  - 修复QQ号和"B站账号信息"文本粘连的问题（如"29338976B站账号信息"）
  - 现在正确显示为"用户 29338976 的B站账号信息"，添加了" 的"分隔符

- **修复temp临时绑定信息显示问题**
  - 全面修复所有可能显示以`_temp_`开头的临时用户名的地方
  - 所有显示MC用户名的位置都正确过滤temp用户名，统一显示为"未绑定"
  - 涉及修复位置：mcid query、finduser、bind命令提示、unbind消息、交互式绑定、管理员列表、服务器白名单显示、天选播报等

- **修复交互式绑定逻辑错误**
  - 修复当用户只绑定B站账号（MC为temp状态）时，使用`@Bot 绑定`错误显示"已完成全部绑定"的问题
  - 新增专门处理只绑定B站用户的逻辑，正确提醒绑定MC账号
  - 修复MC绑定成功后，当用户已有B站账号时，错误要求再次绑定B站的问题
  - 现在MC绑定成功后会自动检查是否已绑定B站，如有则直接完成绑定流程并设置群昵称

### 🔧 逻辑优化
- **完善交互式绑定状态判断**
  - 优化绑定状态检查逻辑，正确过滤临时用户名
  - 确保只有真正完成MC和B站双重绑定的用户才显示"已完成全部绑定"
  - 改进只绑定MC、只绑定B站等不同状态的处理逻辑

- **统一显示标准**
  - 所有用户界面中的MC用户名显示都使用统一的过滤逻辑
  - 确保用户不会看到任何以`_temp_`开头的技术用户名
  - 提升用户体验的一致性

## [1.3.2]

### 🐛 重要修复
- **修复temp用户名显示问题的初步修复**
  - 修复了部分显示temp用户名的问题
  - 为后续完整修复奠定基础

## [1.3.1]

### 🐛 重要修复
- **修复目标用户ID验证逻辑**
  - 确保所有目标用户ID都符合预期


## [1.3.0]

### 🆕 重大功能更新
- **随机提醒系统**
  - 新增智能随机提醒功能，自动检测正在发言用户的绑定状态和群昵称
  - 支持三种场景：完全未绑定、仅绑定B站、群昵称格式错误
  - 触发概率：普通用户 3%，管理员 1%
  - 24小时冷却期，避免重复打扰
  - 自动跳过命令消息和绑定会话中的用户

- **提醒次数记录与警告升级**
  - 数据库新增 `reminderCount` 字段，记录每个用户的累计提醒次数
  - 前三次显示为"提醒"，第四次及以后升级为"警告"
  - 消息前缀显示【第X次提醒】或【第X次警告】
  - 管理员可使用 `clearreminder` 命令重置提醒次数

- **自动群昵称修复**
  - 检测到格式错误时自动修复为规范格式
  - 规范格式：`B站名称（ID:MC用户名）` 或 `B站名称（ID:未绑定）`
  - 修复后给出相应提醒，引导用户保持规范

### 🔧 管理员工具增强
- **批量修复群昵称**：`mcid fixnicknames` 命令一键修复所有用户的群昵称
- **清除提醒记录**：`clearreminder [目标用户]` 清除提醒冷却和次数
- 支持查看详细的修复报告和统计信息

### 🐛 重要修复
- **主动消息不撤回用户消息**
  - 修复随机提醒等主动消息错误撤回用户消息的问题
  - 新增 `isProactiveMessage` 标志区分主动消息和响应消息
  - 确保用户正常聊天不受影响

### 🎨 用户体验优化
- **统一消息格式**
  - MC信息和B站信息之间添加换行符，提高可读性
  - 简化绑定流程消息，移除冗余的管理员通知
  - 新人入群直接在欢迎消息中包含绑定指引

- **群规提醒增强**
  - 聊天取消绑定时添加群规温馨提醒
  - 所有取消绑定场景统一显示群规提醒
  - 强化用户对绑定和群昵称规范的认知

## [1.2.14]

### 🐛 重要修复
- **修复管理员为他人启动绑定流程的消息发送问题**: 现在目标用户能正确收到具体的操作指引
- **完善双消息机制**: 管理员收到确认消息，目标用户收到@提醒和详细指引
- **提升用户体验**: 目标用户现在明确知道自己需要发送什么内容

## [1.2.13]

### 💬 消息策略调整
- **优化新成员绑定提醒**: 移除新成员入群B站绑定提醒中的群规压力警告，使首次体验更友好
- **增强超时提醒**: 在绑定会话超时消息中添加群规提醒，引导用户配合绑定流程

## [1.2.12]

### 🎨 用户体验优化
- **简化B站UID绑定提示**: 根据用户反馈，简化了所有B站UID绑定提示，改为简洁的"请发送您的B站UID"格式
- **移除冗长说明**: 去除了获取UID方法的详细解释，保持界面简洁

## [1.2.11]

### 🔧 用户体验改进
- **优化B站UID绑定提示**: 统一改进所有B站UID绑定场景的提示信息，更明确地告诉用户需要直接发送UID数字
- **涉及场景**:
  - 新成员入群时的B站绑定提示
  - 交互式绑定中跳过MC后的B站绑定提示
  - MC绑定成功后的B站绑定提示
  - 管理员为他人启动B站绑定的提示
  - 已绑定MC用户的B站绑定提示
- **改进内容**: 从简单的"请发送您的B站UID"改为详细的操作指引，包含获取方式和示例

## [1.2.10]

### 🐛 重要Bug修复
- **修复撤回逻辑**: 修复了"🔄 检测到您可能不想继续绑定流程"等绑定提示消息被误设为重要消息不撤回的问题，现在这些消息会正常撤回
- **只有绑定会话超时提醒不被撤回**: 现在只有真正重要的"绑定会话已超时，请重新开始绑定流程"消息不会被撤回

### ⚡ 冷却时间优化
- **统一冷却时间**: 移除所有3倍冷却时间限制，现在MC绑定、MC修改、B站绑定的冷却时间都统一为标准冷却时间
- **简化用户体验**: 用户不再需要等待额外的冷却时间即可进行账号绑定操作
- **涉及功能**: 
  - `mcid bind` MC账号绑定
  - `mcid change` MC账号修改  
  - `buid bind` B站账号绑定
  - 交互式绑定流程中的冷却检查

## [1.2.9]

### 🔧 功能改进
- **优化MC绑定后群昵称设置**：
  - 当用户已绑定B站账号时，MC绑定完成后自动设置群昵称
  - 当用户未绑定B站账号时，提醒用户使用 `buid bind` 命令完成B站绑定
  - 管理员为他人绑定MC账号时，同样遵循以上逻辑
- **修复查询权限**: 普通用户现在无法查询其他用户的MC账号信息，只有管理员才能查询他人信息
- **优化撤回逻辑**: 
  - 修复绑定指令被误判为聊天消息的问题
  - 现在 `🤔 您当前正在进行绑定流程` 和 `🔄 检测到您可能不想继续绑定流程` 提示会正常撤回
  - 只有真正重要的消息（如绑定会话超时提醒）不会被撤回

### 🐛 Bug修复
- **修复聊天消息过滤**: 完全去除对UID/数字串长度的校验，支持任意长度的有效UID
- **修复绑定会话超时提醒**: 现在会@用户发送超时提醒
- **修复用户消息撤回逻辑**: 绑定指令不再被误判为聊天消息而跳过撤回

## [1.2.7]

### 🐛 关键Bug修复
- **完全去除UID长度校验**: 移除所有对UID/数字串长度的限制，支持任意长度的有效UID
- **修复绑定会话超时提醒**: 现在绑定会话超时时会@用户，让用户明确知道自己的绑定已超时
- **优化绑定会话中的聊天处理**: 用户在绑定过程中发送聊天消息时，不再撤回用户的消息，让正常聊天体验更流畅

### 🔧 改进
- **智能聊天检测**: 进一步优化聊天内容与绑定输入的区分逻辑
- **用户体验提升**: 绑定过程中的所有重要提示都不会被自动撤回

## [1.2.6]

### 🐛 关键Bug修复
- **修复有效UID被误判为聊天消息**: 调整数字串长度检查阈值，避免8位有效UID（如"38818555"）被误判为无关输入
- **修复绑定会话中用户聊天消息被撤回**: 现在用户在绑定过程中发送聊天消息时，不会撤回用户的消息，让用户可以正常聊天

### 🔧 改进
- **智能消息撤回**: 区分有效绑定输入和聊天消息，只撤回真正的指令消息
- **更精确的输入判断**: 优化聊天内容识别逻辑，减少误判

## [1.2.5]

### 🐛 Bug修复
- **修复跳过MC绑定的SQL错误**: 为跳过MC绑定的用户生成唯一临时用户名，避免数据库唯一性约束冲突
- **修复聊天消息过滤逻辑**: 重要的绑定提示消息（如"您当前正在进行绑定流程"等）不会被自动撤回
- **优化群昵称修改**: 先比对当前昵称与目标昵称，相同时跳过修改，减少不必要的API调用

### 🔧 改进
- **完善临时用户名处理**: 确保所有功能中临时用户名（`_temp_`开头）都被正确识别为"未绑定"状态
- **增强日志记录**: 群昵称设置时会显示从旧昵称到新昵称的变更信息

## [1.2.4]

### 🐛 修复与改进
- **修复交互式绑定跳过功能失效的问题**
  - 修复"跳过"命令在等待MC用户名状态时被误判为无关输入的bug
  - 现在用户可以正常使用"跳过"直接进入B站绑定流程
- **文档优化**
  - 删除README中的详细版本历史，改为引用CHANGELOG.md

## [1.2.3]

### 🔧 绑定流程优化
- **移除B站绑定跳过选项**
  - 用户必须绑定B站账号，不再允许跳过B站绑定步骤
  - 简化交互式绑定流程，确保用户完成完整绑定
  - 更新所有相关错误提示，移除跳过选项的引导

### 🆕 新增功能
- **新人入群自动启动绑定流程**
  - 新成员加入群聊时自动为其启动交互式绑定流程
  - 根据用户现有绑定状态智能判断下一步操作
  - 已完成全部绑定的用户不会收到重复提醒
- **管理员绑定命令增强**
  - 新增 `绑定 <目标用户>` 命令，管理员可为他人启动绑定流程
  - 智能检测目标用户当前绑定状态并引导至相应步骤
  - 支持为目标用户创建绑定会话并发送@提醒

### 🔧 配置调整
- **autoNicknameGroupId 默认值更新**
  - 默认群ID从 `931805503` 改为 `123456789`
  - 便于用户根据实际需要进行配置

### 📋 群规管理优化
- **增强群规遵守提醒**
  - 在绑定会话取消时（手动取消或自动取消）添加群规提醒
  - 明确说明不配合绑定的后果，提高用户配合度
  - 移除绑定成功后多余的群昵称设置提醒（系统会自动设置）

### 🐛 修复与改进
- **代码清理**
  - 删除未使用的"取消次数"相关代码
  - 优化绑定会话管理逻辑
- **@botNickname前缀支持扩展**
  - 现在支持使用 `@机器人昵称 绑定` 启动交互式绑定
  - 完善前缀匹配逻辑，支持所有主要命令

## [1.2.2]

### 🐛 重要修复
- **管理员查询群昵称设置bug修复**
  - 修复管理员查询别人MC账号时错误设置管理员群昵称的问题
  - 现在正确设置被查询用户的群昵称而非管理员自己的

### 🆕 新增功能
- **支持只绑定B站账号用户的群昵称设置**
  - 完善群昵称格式：有MC账号显示`B站昵称（ID:MC用户名）`，无MC账号显示`B站昵称（ID:未绑定）`
  - 所有B站绑定流程都支持群昵称设置：交互绑定、buid bind命令、管理员为他人绑定
  - 确保绑定过程丝滑，多用户无MC账号时绑定buid正常工作

### 🔧 功能改进
- **群昵称设置逻辑优化**
  - 统一所有绑定流程的群昵称设置处理
  - 智能检测临时用户名，避免显示无效的MC绑定信息
  - 增强错误处理，群昵称设置失败不影响主绑定流程

## [1.2.1]

### 🎨 用户体验优化
- **群昵称格式优化**
  - 修改群昵称格式中的冒号为英文冒号：`WittF（ID:WittF）`
  - 统一所有相关显示格式，提高可读性

### 🆕 新增功能
- **mcid query 自动重命名**
  - 查询MC账号时自动触发群昵称设置功能（需两个账号都已绑定）
  - 查询他人和查询自己都支持自动重命名功能
  - 如果MC或B站有一个未绑定，跳过重命名并提示用户去绑定

- **完整解绑功能**
  - `mcid unbind` 命令现在同时解绑MC和B站账号
  - 解绑消息会显示被解绑的所有账号信息
  - 简化用户操作，避免需要分别解绑两个账号

### 🔧 功能改进  
- **绑定会话冲突处理**
  - 在交互式绑定过程中检测其他绑定指令输入
  - 智能提醒用户继续当前绑定流程或取消后重新绑定
  - 防止绑定过程中的误操作和混乱

## [1.2.0]

### 🆕 新增功能
- **交互式绑定系统**
  - 新增`mcid 绑定`命令，提供引导式的绑定流程
  - 支持3分钟会话超时，自动清理无响应会话
  - 智能检测无关输入，第1次提醒检查，第2次自动取消会话
  - 支持MC和B站账号连续绑定，用户体验更加友好
  - 支持中途取消和跳过B站绑定功能
  - **自动群昵称设置**：绑定完成后自动设置群昵称（群名片）
    - 格式："B站昵称（ID:MC用户名）"，如 `籽岷（ID:Zi__Min）`
    - 修复OneBot API调用格式，解决retcode 1400错误
    - **新增配置参数**：`autoNicknameGroupId` 可自定义目标群ID（默认：931805503）

- **智能绑定流程优化**
  - 如果用户已绑定MC但未绑定B站，直接进入B站绑定流程
  - 如果用户已完成全部绑定，显示当前绑定信息而非重复绑定

- **标签重命名功能**
  - 新增`mcid tag rename <旧标签名> <新标签名>`命令，支持管理员重命名现有标签
  - 支持格式验证和冲突检查，确保新标签名不与现有标签冲突
  - 批量更新所有拥有该标签的用户，提供详细的操作结果统计

### 🎨 显示优化
- **天选开奖通知优化**
  - 群消息中新增总中奖人数显示
  - 当有未绑定用户时，会显示"其中X人未绑定跳过"的说明
  - 提高用户对天选开奖结果的理解，明确展示跳过的未绑定用户数量

### 🔧 功能改进
- **绑定流程智能化**
  - 交互式绑定支持多种输入格式和错误提示
  - 优化用户引导和操作提示，降低使用门槛
  - 增强会话管理和超时处理机制

### 🎨 用户体验优化
- **简化绑定指令**：绑定命令改为直接 `绑定` 而非 `mcid 绑定`
- **简化消息内容**：大幅简化交互式绑定过程中的提示消息，减少刷屏
- **群昵称设置优化**：统一只在指定群设置昵称，避免重复操作

## [1.1.6]

### 🆕 API升级支持
- **支持ZMINFO API v1.1.0新特性**
  - 新增`max_guard_level`和`max_guard_level_text`字段支持
  - 数据库增加历史最高舰长等级字段（`maxGuardLevel`和`maxGuardLevelText`）
  - 自动数据库结构升级，兼容现有数据

### 🎨 显示优化
- **智能历史舰长等级显示**
  - 只有当历史最高等级比当前等级更高时才显示历史最高信息
  - 当前无舰长但有历史记录时，显示"历史舰长"
  - 避免重复显示相同等级信息，提升用户体验
  - 明确舰长等级编号：0=非舰长，1=总督，2=提督，3=舰长

### 🔧 功能改进
- **完善B站账号信息更新机制**
  - 绑定和查询时自动获取并存储历史最高舰长等级
  - 支持智能等级更新逻辑，防止数据回退
  - 所有B站相关查询命令都支持历史舰长等级显示

## [1.1.5]

### 🐛 显示优化修复
- **mcid query命令图片显示顺序统一**
  - 修复查询别人(`mcid query @用户`)和查询自己(`mcid query`)时图片显示顺序不一致的问题
  - 统一为4段式显示格式：MC信息文本 → MC图片 → B站信息文本 → B站图片
  - 改进B站信息文本的独立显示，避免与其他信息混合在一起
  - 提升用户体验，保持所有查询命令的显示一致性

## [1.1.2]

### 🐛 重要修复
- **B站账号查询时间问题修复**
  - 修复了`buid query`命令查询时错误更新`lastModified`绑定时间的问题
  - 创建专用的`updateBuidInfoOnly`函数，仅更新B站信息，不影响绑定时间
  - 查询日志现在显示为"刷新信息"而非"更新绑定"，更加准确

### 🆕 新增功能
- **天选播报功能开关**
  - 新增`enableLotteryBroadcast`配置项（默认为`false`）
  - 可通过配置文件完全控制天选播报功能的开启/关闭
  - 关闭时在webhook入口处直接返回，提高性能

### 🔧 功能改进
- 优化日志记录，使用更准确的术语区分"绑定"和"信息刷新"
- 改进天选播报的错误处理和资源控制
- 增强配置项的描述和默认值设置

## [1.1.1]

### 🚀 性能优化
- **B站UID绑定逻辑优化**
  - 优化绑定流程顺序，先检查用户状态和权限再调用API
  - 避免不必要的ZMINFO API请求，提高效率
  - 减少API调用频次，降低请求失败风险

### 🆕 新增功能
- **灵活的UID输入格式支持**
  - `buid bind` 命令现在支持 `UID:12345` 和 `12345` 两种格式
  - `buid finduser` 命令同样支持带前缀的UID格式
  - 提供更友好的用户体验和操作便利性

### 🎨 图像显示增强
- **B站头像高清显示**
  - 所有B站头像链接添加 `?size=160` 参数
  - 显示160像素高清头像，提升视觉效果
  - 涵盖所有使用B站头像的场景：查询、绑定等

### 🔧 功能改进
- 完善错误提示信息，支持多种UID输入格式
- 优化绑定验证逻辑，减少重复检查
- 改进日志记录，使用更友好的术语（如"B站账号"替代"BUID"）

## [1.0.10]

### 🔧 配置优化
- **图像显示配置重构**
  - 将 `showBuidAvatar` 重命名为 `showAvatar`，作为图像显示总开关
  - `showMcSkin` 现在需要 `showAvatar` 开启后才能使用，控制MC是否使用皮肤渲染图
  - 简化MC头图API，直接使用 `https://crafatar.com/avatars/uuid`

### 🆕 新增功能
- **buid query命令图像显示**
  - 在 `buid query` 命令中添加B站头像显示
  - 根据 `showAvatar` 配置决定是否显示图像

### 🔧 功能改进
- **智能图像显示逻辑**
  - `showAvatar=false`：不显示任何图像
  - `showAvatar=true & showMcSkin=false`：MC显示头图，B站显示头像
  - `showAvatar=true & showMcSkin=true`：MC显示皮肤渲染图，B站显示头像
- 移除了复杂的头像缓存机制，简化代码结构
- 优化所有MC相关命令的图像显示逻辑

## [1.0.9]

### 🐛 修复
- **B站绑定成功消息重复问题**
  - 修复B站账号绑定成功后显示重复"绑定成功！"消息的问题
  - 现在只显示一次"成功绑定B站账号！"信息

- **Mojang API 403错误处理**
  - 修复遇到403 Forbidden错误时不自动切换备用API的问题
  - 现在403错误也会触发备用API fallback机制
  - 提高用户名验证和UUID查询的成功率

### 🆕 新增功能
- **mcid query B站绑定提醒**
  - 在查询MC账号时，如果用户未绑定B站账号，会显示相应提醒
  - 查询他人：显示"该用户尚未绑定B站账号"
  - 查询自己：显示"您尚未绑定B站账号，使用 `buid bind <B站UID>` 进行绑定"

### 🔧 功能改进
- 优化错误处理逻辑，增强API容错能力
- 改进用户体验，提供更清晰的操作指引

## [1.0.8]

### 🔧 功能改进
- **头像显示分离开关**
  - 将原来的 `showAvatar` 分离为 `showMcSkin` 和 `showBuidAvatar` 两个独立开关
  - 用户可以分别控制是否显示MC皮肤和B站头像
- **绑定成功消息优化**
  - 移除B站UID绑定成功消息中重复的"绑定成功！"文本
  - 简化消息内容，避免重复信息

### 🐛 修复
- **mcid query B站头像显示**
  - 修复 mcid query 命令中B站头像不显示的问题
  - 确保在启用 showBuidAvatar 时正确显示B站头像

## [1.0.7]

### 🐛 修复
- **BUID绑定数据库约束错误**
  - 修复"UNIQUE constraint failed: mcidbind.mcUsername"错误
  - 现在要求用户必须先绑定MC账号才能绑定B站UID
  - 避免创建空mcUsername记录导致的数据库冲突

### 🔧 功能优化
- **时间显示优化**
  - B站最后活跃时间显示改为UTC+8中国上海时区
  - 时间格式更符合中国用户习惯
- **B站头像显示改进**
  - 简化B站头像URL构建逻辑
  - 直接通过UID构建头像URL，无需存储到数据库

### 🛡️ 安全改进
- 增强BUID绑定验证流程，确保数据完整性

## [1.0.6]

### 🆕 功能与优化
- **mcid query B站信息优化**
  - B站账号信息不再显示"最后活跃时间"字段
  - 支持显示B站头像（showAvatar为true时，自动展示B站头像图片）
- **指令前缀兼容性修复**
  - 修复昵称前缀下 buid 指令无法触发的问题，现支持"@机器人 buid ..."格式
- **其它细节优化与修复**
  - 代码结构优化，提升健壮性
  - 文档和注释完善

## [1.0.5]

### 🎨 新增功能
- **B站UID绑定功能**
  - 支持绑定和查询B站账号信息
  - 集成ZMINFO API获取详细用户数据
  - B站UID绑定冷却时间为MC绑定的3倍
  - 在MC查询中同时显示B站信息
  - 显示B站用户名、舰长等级、粉丝牌、荣耀等级等

### 🔧 功能改进
- **头像显示优化**
  - 配置项从 `showPlayerAvatar` 改为 `showAvatar`
  - 支持显示MC皮肤和B站头像
  - B站头像使用专用URL格式：`https://workers.vrp.moe/bilibili/avatar/<UID>`

### 📝 文档更新
- 完善README.md，添加B站UID绑定相关指令说明
- 更新配置项说明，包括新增的zminfoApiUrl和修改后的showAvatar
- 优化指令分类，提高文档可读性
- 添加详细的使用示例

### 🛡️ 安全改进
- 增强B站UID验证机制
- 完善错误处理和日志记录

---

## [1.0.4]

### 🎨 新增功能
- **可选玩家头像显示**
  - 新增 `showPlayerAvatar` 配置项（默认为 `false`）
  - 支持在以下命令中控制是否显示玩家皮肤图片：
    - `mcid query` / `mcid query [目标用户]`
    - `mcid bind` / `mcid bind <用户名> [目标用户]`
    - `mcid change` / `mcid change <用户名> [目标用户]`
    - `mcid finduser <用户名>`

### 🔧 功能改进
- **优化 reset 命令**
  - 现在支持直接删除任意服务器ID的白名单记录
  - 无需验证服务器是否存在于当前配置中
  - 便于清理已从配置中删除但数据库中仍存在的服务器ID

### 🆕 新增命令
- **`mcid whitelist resetall`** (主人权限)
  - 一键清理所有未在服务器配置列表中的无效白名单ID
  - 提供详细的清理报告，包括处理记录数、更新记录数、移除的无效条目数
  - 列出所有发现的无效服务器ID

- **`mcid tag deleteall <标签名>`** (主人权限)
  - 一键删除所有用户的指定标签
  - 支持批量操作，提供详细的操作结果统计
  - 安全的权限控制，仅主人可执行

### ⚡ 性能优化
- **改进 RCON 排队机制**
  - `mcid whitelist addall` 命令现按绑定时间排序处理（早绑定用户优先）
  - 移除并发处理，改为真正的队列机制，确保每个RCON命令等待上一个完成后再继续
  - 增加处理间隔（1秒），避免RCON服务器过载
  - 降低并发冲突风险，提高批量操作稳定性

### 🛡️ 安全改进
- **增强配置访问防护**
  - 所有 `config.showPlayerAvatar` 访问都改为 `config?.showPlayerAvatar`
  - 提高代码对异常配置状态的容错性
  - 防止因配置对象不存在导致的运行时错误

### 📝 文档更新
- 更新 README.md，添加新功能的使用说明
- 更新 package.json 描述，反映最新功能特性
- 完善配置项说明文档

---

## [1.0.3]

### 新增功能
- 支持解析 `<at id="..."/>` 格式的@用户字符串
- 改进用户ID处理：增强对不同@用户格式的兼容性
- 添加构建发布脚本：新增自动化构建和发布的bat脚本

---

## [1.0.2]

### 修复
- 修复Logger名称：将内部日志记录器名称从'bind-mcid'更新为'mcid-bot'
- 代码清理：确保所有内部引用都使用正确的项目名称

---

## [1.0.1]

### 初始发布
- 支持Minecraft账号绑定和管理功能
- 支持多服务器白名单管理
- 支持用户标签系统，便于批量管理
- 支持批量白名单操作
- 支持管理员权限控制
- 支持RCON连接管理
- 支持消息自动撤回
- 支持文本前缀触发指令
- 完整的错误处理和日志系统 