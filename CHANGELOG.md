# 更新日志

## [1.1.8] - 2025-06-15

### 🆕 新增功能
- **交互式绑定系统**
  - 新增`mcid 绑定`命令，提供引导式的绑定流程
  - 支持3分钟会话超时，自动清理无响应会话
  - 智能检测无关输入，第1次提醒检查，第2次自动取消会话
  - 支持MC和B站账号连续绑定，用户体验更加友好
  - 支持中途取消和跳过B站绑定功能
  - **自动群昵称设置**：绑定完成后自动设置群昵称（群名片）为"B站昵称（ID：MC用户名）"格式
    - 群聊绑定：在当前群和指定群(931805503)中设置昵称
    - 私聊绑定：在指定群(931805503)中设置昵称

- **智能绑定流程优化**
  - 如果用户已绑定MC但未绑定B站，直接进入B站绑定流程
  - 如果用户已完成全部绑定，显示当前绑定信息而非重复绑定

- **标签重命名功能**
  - 新增`mcid tag rename <旧标签名> <新标签名>`命令，支持管理员重命名现有标签
  - 支持格式验证和冲突检查，确保新标签名不与现有标签冲突
  - 批量更新所有拥有该标签的用户，提供详细的操作结果统计

### 🎨 显示优化
- **天选开奖通知优化**
  - 群消息中新增总中奖人数显示
  - 当有未绑定用户时，会显示"其中X人未绑定跳过"的说明
  - 提高用户对天选开奖结果的理解，明确展示跳过的未绑定用户数量

### 🔧 功能改进
- **绑定流程智能化**
  - 交互式绑定支持多种输入格式和错误提示
  - 优化用户引导和操作提示，降低使用门槛
  - 增强会话管理和超时处理机制

## [1.1.6] - 2025-06-14

### 🆕 API升级支持
- **支持ZMINFO API v1.1.0新特性**
  - 新增`max_guard_level`和`max_guard_level_text`字段支持
  - 数据库增加历史最高舰长等级字段（`maxGuardLevel`和`maxGuardLevelText`）
  - 自动数据库结构升级，兼容现有数据

### 🎨 显示优化
- **智能历史舰长等级显示**
  - 只有当历史最高等级比当前等级更高时才显示历史最高信息
  - 当前无舰长但有历史记录时，显示"历史舰长"
  - 避免重复显示相同等级信息，提升用户体验
  - 明确舰长等级编号：0=非舰长，1=总督，2=提督，3=舰长

### 🔧 功能改进
- **完善B站账号信息更新机制**
  - 绑定和查询时自动获取并存储历史最高舰长等级
  - 支持智能等级更新逻辑，防止数据回退
  - 所有B站相关查询命令都支持历史舰长等级显示

## [1.1.5] - 2025-06-14

### 🐛 显示优化修复
- **mcid query命令图片显示顺序统一**
  - 修复查询别人(`mcid query @用户`)和查询自己(`mcid query`)时图片显示顺序不一致的问题
  - 统一为4段式显示格式：MC信息文本 → MC图片 → B站信息文本 → B站图片
  - 改进B站信息文本的独立显示，避免与其他信息混合在一起
  - 提升用户体验，保持所有查询命令的显示一致性

## [1.1.2] - 2025-06-14

### 🐛 重要修复
- **B站账号查询时间问题修复**
  - 修复了`buid query`命令查询时错误更新`lastModified`绑定时间的问题
  - 创建专用的`updateBuidInfoOnly`函数，仅更新B站信息，不影响绑定时间
  - 查询日志现在显示为"刷新信息"而非"更新绑定"，更加准确

### 🆕 新增功能
- **天选播报功能开关**
  - 新增`enableLotteryBroadcast`配置项（默认为`false`）
  - 可通过配置文件完全控制天选播报功能的开启/关闭
  - 关闭时在webhook入口处直接返回，提高性能

### 🔧 功能改进
- 优化日志记录，使用更准确的术语区分"绑定"和"信息刷新"
- 改进天选播报的错误处理和资源控制
- 增强配置项的描述和默认值设置

## [1.1.1] - 2025-06-13

### 🚀 性能优化
- **B站UID绑定逻辑优化**
  - 优化绑定流程顺序，先检查用户状态和权限再调用API
  - 避免不必要的ZMINFO API请求，提高效率
  - 减少API调用频次，降低请求失败风险

### 🆕 新增功能
- **灵活的UID输入格式支持**
  - `buid bind` 命令现在支持 `UID:12345` 和 `12345` 两种格式
  - `buid finduser` 命令同样支持带前缀的UID格式
  - 提供更友好的用户体验和操作便利性

### 🎨 图像显示增强
- **B站头像高清显示**
  - 所有B站头像链接添加 `?size=160` 参数
  - 显示160像素高清头像，提升视觉效果
  - 涵盖所有使用B站头像的场景：查询、绑定等

### 🔧 功能改进
- 完善错误提示信息，支持多种UID输入格式
- 优化绑定验证逻辑，减少重复检查
- 改进日志记录，使用更友好的术语（如"B站账号"替代"BUID"）

## [1.0.10] - 2025-06-12

### 🔧 配置优化
- **图像显示配置重构**
  - 将 `showBuidAvatar` 重命名为 `showAvatar`，作为图像显示总开关
  - `showMcSkin` 现在需要 `showAvatar` 开启后才能使用，控制MC是否使用皮肤渲染图
  - 简化MC头图API，直接使用 `https://crafatar.com/avatars/uuid`

### 🆕 新增功能
- **buid query命令图像显示**
  - 在 `buid query` 命令中添加B站头像显示
  - 根据 `showAvatar` 配置决定是否显示图像

### 🔧 功能改进
- **智能图像显示逻辑**
  - `showAvatar=false`：不显示任何图像
  - `showAvatar=true & showMcSkin=false`：MC显示头图，B站显示头像
  - `showAvatar=true & showMcSkin=true`：MC显示皮肤渲染图，B站显示头像
- 移除了复杂的头像缓存机制，简化代码结构
- 优化所有MC相关命令的图像显示逻辑

## [1.0.9] - 2025-06-11

### 🐛 修复
- **B站绑定成功消息重复问题**
  - 修复B站账号绑定成功后显示重复"绑定成功！"消息的问题
  - 现在只显示一次"成功绑定B站账号！"信息

- **Mojang API 403错误处理**
  - 修复遇到403 Forbidden错误时不自动切换备用API的问题
  - 现在403错误也会触发备用API fallback机制
  - 提高用户名验证和UUID查询的成功率

### 🆕 新增功能
- **mcid query B站绑定提醒**
  - 在查询MC账号时，如果用户未绑定B站账号，会显示相应提醒
  - 查询他人：显示"该用户尚未绑定B站账号"
  - 查询自己：显示"您尚未绑定B站账号，使用 `buid bind <B站UID>` 进行绑定"

### 🔧 功能改进
- 优化错误处理逻辑，增强API容错能力
- 改进用户体验，提供更清晰的操作指引

## [1.0.8] - 2025-06-10

### 🔧 功能改进
- **头像显示分离开关**
  - 将原来的 `showAvatar` 分离为 `showMcSkin` 和 `showBuidAvatar` 两个独立开关
  - 用户可以分别控制是否显示MC皮肤和B站头像
- **绑定成功消息优化**
  - 移除B站UID绑定成功消息中重复的"绑定成功！"文本
  - 简化消息内容，避免重复信息

### 🐛 修复
- **mcid query B站头像显示**
  - 修复 mcid query 命令中B站头像不显示的问题
  - 确保在启用 showBuidAvatar 时正确显示B站头像

## [1.0.7] - 2025-06-09

### 🐛 修复
- **BUID绑定数据库约束错误**
  - 修复"UNIQUE constraint failed: mcidbind.mcUsername"错误
  - 现在要求用户必须先绑定MC账号才能绑定B站UID
  - 避免创建空mcUsername记录导致的数据库冲突

### 🔧 功能优化
- **时间显示优化**
  - B站最后活跃时间显示改为UTC+8中国上海时区
  - 时间格式更符合中国用户习惯
- **B站头像显示改进**
  - 简化B站头像URL构建逻辑
  - 直接通过UID构建头像URL，无需存储到数据库

### 🛡️ 安全改进
- 增强BUID绑定验证流程，确保数据完整性

## [1.0.6] - 2025-06-08

### 🆕 功能与优化
- **mcid query B站信息优化**
  - B站账号信息不再显示"最后活跃时间"字段
  - 支持显示B站头像（showAvatar为true时，自动展示B站头像图片）
- **指令前缀兼容性修复**
  - 修复昵称前缀下 buid 指令无法触发的问题，现支持"@机器人 buid ..."格式
- **其它细节优化与修复**
  - 代码结构优化，提升健壮性
  - 文档和注释完善

## [1.0.5] - 2025-06-07

### 🎨 新增功能
- **B站UID绑定功能**
  - 支持绑定和查询B站账号信息
  - 集成ZMINFO API获取详细用户数据
  - B站UID绑定冷却时间为MC绑定的3倍
  - 在MC查询中同时显示B站信息
  - 显示B站用户名、舰长等级、粉丝牌、荣耀等级等

### 🔧 功能改进
- **头像显示优化**
  - 配置项从 `showPlayerAvatar` 改为 `showAvatar`
  - 支持显示MC皮肤和B站头像
  - B站头像使用专用URL格式：`https://workers.vrp.moe/bilibili/avatar/<UID>`

### 📝 文档更新
- 完善README.md，添加B站UID绑定相关指令说明
- 更新配置项说明，包括新增的zminfoApiUrl和修改后的showAvatar
- 优化指令分类，提高文档可读性
- 添加详细的使用示例

### 🛡️ 安全改进
- 增强B站UID验证机制
- 完善错误处理和日志记录

---

## [1.0.4] - 2025-06-06

### 🎨 新增功能
- **可选玩家头像显示**
  - 新增 `showPlayerAvatar` 配置项（默认为 `false`）
  - 支持在以下命令中控制是否显示玩家皮肤图片：
    - `mcid query` / `mcid query [目标用户]`
    - `mcid bind` / `mcid bind <用户名> [目标用户]`
    - `mcid change` / `mcid change <用户名> [目标用户]`
    - `mcid finduser <用户名>`

### 🔧 功能改进
- **优化 reset 命令**
  - 现在支持直接删除任意服务器ID的白名单记录
  - 无需验证服务器是否存在于当前配置中
  - 便于清理已从配置中删除但数据库中仍存在的服务器ID

### 🆕 新增命令
- **`mcid whitelist resetall`** (主人权限)
  - 一键清理所有未在服务器配置列表中的无效白名单ID
  - 提供详细的清理报告，包括处理记录数、更新记录数、移除的无效条目数
  - 列出所有发现的无效服务器ID

- **`mcid tag deleteall <标签名>`** (主人权限)
  - 一键删除所有用户的指定标签
  - 支持批量操作，提供详细的操作结果统计
  - 安全的权限控制，仅主人可执行

### ⚡ 性能优化
- **改进 RCON 排队机制**
  - `mcid whitelist addall` 命令现按绑定时间排序处理（早绑定用户优先）
  - 移除并发处理，改为真正的队列机制，确保每个RCON命令等待上一个完成后再继续
  - 增加处理间隔（1秒），避免RCON服务器过载
  - 降低并发冲突风险，提高批量操作稳定性

### 🛡️ 安全改进
- **增强配置访问防护**
  - 所有 `config.showPlayerAvatar` 访问都改为 `config?.showPlayerAvatar`
  - 提高代码对异常配置状态的容错性
  - 防止因配置对象不存在导致的运行时错误

### 📝 文档更新
- 更新 README.md，添加新功能的使用说明
- 更新 package.json 描述，反映最新功能特性
- 完善配置项说明文档

---

## [1.0.3] - 2025-06-05

### 新增功能
- 支持解析 `<at id="..."/>` 格式的@用户字符串
- 改进用户ID处理：增强对不同@用户格式的兼容性
- 添加构建发布脚本：新增自动化构建和发布的bat脚本

---

## [1.0.2] - 2025-06-04

### 修复
- 修复Logger名称：将内部日志记录器名称从'bind-mcid'更新为'mcid-bot'
- 代码清理：确保所有内部引用都使用正确的项目名称

---

## [1.0.1] - 2025-06-03

### 初始发布
- 支持Minecraft账号绑定和管理功能
- 支持多服务器白名单管理
- 支持用户标签系统，便于批量管理
- 支持批量白名单操作
- 支持管理员权限控制
- 支持RCON连接管理
- 支持消息自动撤回
- 支持文本前缀触发指令
- 完整的错误处理和日志系统 