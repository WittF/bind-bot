# koishi-plugin-bind-mcid 指令使用说明

## 普通用户命令
- `mcid bind <用户名>` 绑定Minecraft账号
- `mcid query` 查询自己绑定的Minecraft账号
- `mcid change <用户名>` 修改绑定的Minecraft账号
- `mcid unbind` 解绑Minecraft账号
- `mcid whitelist servers` 列出所有可用的Minecraft服务器
- `mcid whitelist add <服务器名称或ID>` 申请添加服务器白名单（需服务器允许自助申请）

## 管理员命令
- `mcid bind <用户名> [目标用户]` 为指定用户绑定Minecraft账号
- `mcid query [目标用户]` 查询指定用户绑定的Minecraft账号
- `mcid finduser <用户名>` 通过Minecraft用户名查询绑定的QQ账号
- `mcid change <用户名> [目标用户]` 修改指定用户绑定的Minecraft账号
- `mcid unbind [目标用户]` 为指定用户解绑Minecraft账号
- `mcid whitelist add <服务器名称或ID> [目标用户]` 为指定用户添加服务器白名单
- `mcid whitelist remove <服务器名称或ID> [目标用户]` 为指定用户移除服务器白名单
- `mcid whitelist addall <服务器名称或ID>` 将所有已绑定MC账号的用户添加到指定服务器白名单

## 主人命令
- `mcid admin <目标用户>` 将用户设为管理员
- `mcid unadmin <目标用户>` 撤销用户的管理员权限
- `mcid adminlist` 列出所有管理员
- `mcid whitelist reset <服务器名称或ID>` 重置指定服务器的所有白名单数据库记录

## 配置项说明

| 配置项 | 类型 | 默认值 | 说明 |
|-------|-----|-------|------|
| cooldownDays | number | 15 | 修改绑定的冷却时间(天) |
| masterId | string | '' | 主人QQ号，拥有管理员管理权限 |
| allowTextPrefix | boolean | false | 是否允许通过文本前缀触发指令 |
| botNickname | string | '' | 机器人昵称，用于文本前缀匹配 |
| autoRecallTime | number | 0 | 消息自动撤回时间(秒)，同时控制机器人和用户消息，0表示不自动撤回 |
| recallUserMessage | boolean | false | 是否撤回用户发送的指令消息（仅群聊消息） |
| debugMode | boolean | false | 调试模式，启用详细日志输出 |
| servers | array | [] | Minecraft服务器配置列表 |

### 服务器配置项

| 配置项 | 类型 | 默认值 | 说明 |
|-------|-----|-------|------|
| id | string | (必填) | 服务器唯一ID |
| name | string | (必填) | 服务器名称 |
| enabled | boolean | true | 服务器是否启用，停用后不会显示在列表中 |
| displayAddress | string | '' | 服务器展示地址 |
| description | string | '' | 服务器说明信息 |
| rconAddress | string | (必填) | RCON地址，格式为IP:端口 |
| rconPassword | string | '' | RCON密码 |
| addCommand | string | 'whitelist add ${MCID}' | 添加白名单命令模板 |
| removeCommand | string | 'whitelist remove ${MCID}' | 移除白名单命令模板 |
| idType | string | 'username' | 白名单添加时使用的ID类型(username或uuid) |
| allowSelfApply | boolean | false | 是否允许用户自行申请白名单 |
| acceptEmptyResponse | boolean | false | 是否将命令的空响应视为成功 |

## 版本历史

### v1.4.0 (最新)
- 全面优化日志系统：大幅减少常规操作的日志输出，提高运行效率
- 改进日志架构：引入操作记录机制，重要操作保留关键日志，调试信息仅在调试模式显示
- 改进私聊消息处理：私聊消息不再撤回机器人和用户消息，仅群聊中启用撤回功能
- 重构消息处理逻辑：简化消息发送和撤回流程，提高代码可维护性

### v1.3.9
- 优化日志输出策略：新增`debugMode`配置项，用于控制调试日志输出
- 重构日志系统：添加统一的日志辅助函数，提高日志规范性和可读性
- 改进RCON连接管理：优化RCON管理器的日志策略，减少非调试模式下的日志量
- 提升插件性能：减少不必要的调试信息，降低运行时资源占用

### v1.3.8
- 优化用户消息撤回：私聊消息不再撤回用户指令消息，仅撤回群聊中的指令消息
- 改进撤回逻辑：增加消息类型判断，避免在私聊环境中尝试撤回消息
- 更新日志输出：区分私聊和群聊场景的日志记录

### v1.3.7
- 添加撤回用户消息功能：新增`recallUserMessage`配置项，开启后可自动撤回用户的指令消息
- 统一撤回时间控制：`autoRecallTime`配置现在同时控制机器人消息和用户消息的撤回时间
- 优化日志输出：添加用户消息撤回相关日志

### v1.3.6
- 新增管理员命令：`mcid finduser <用户名>` 支持通过Minecraft用户名反向查询绑定的QQ账号
- 管理员查询时显示更多详细信息：白名单服务器列表、绑定时间和管理员权限状态
- 优化反向查询结果展示：包含用户皮肤渲染和UUID格式化显示

### v1.3.5
- 增强服务器标识支持：所有白名单相关命令现在可以同时通过服务器名称或ID来操作
- 优化服务器列表显示：在服务器信息中添加ID字段，方便用户直接使用
- 改进服务器识别：添加getServerConfigByIdOrName函数，优先使用ID精确匹配，找不到再用名称匹配
- 批量白名单速率限制：批量添加白名单时限制为最多每秒2个，避免服务器过载
- 优化批量操作间隔：增加500毫秒强制延迟，确保服务器能够稳定处理请求

### v1.3.4
- 优化日志输出：减少重复日志条目，避免同一操作多次记录
- 改进日志级别划分：将部分调试信息改为debug级别，使重要信息更加突出
- 精简批量处理日志：减少大量操作时的日志冗余，提高日志可读性
- 优化批量白名单通知频率：将进度通知调整为每20%发送一次，减少消息频率
- 改进批量处理过程的用户体验，避免过多的通知消息

### v1.3.3
- 优化RCON连接管理：减少心跳检测间隔至5分钟，提高连接稳定性
- 增强连接状态监测：添加主动ping检测，提前发现并自动修复断开的连接
- 改进错误处理：细化RCON错误分类和处理流程，提供更精确的错误提示
- 优化批量白名单功能：动态调整并发数，根据数量自动选择2-5的并发级别
- 完善批量处理进度通知：添加成功/失败/跳过实时统计，优化进度显示
- 改进服务器名称匹配算法：添加最小相似度阈值(60%)，避免过度模糊匹配
- 增强Levenshtein距离计算：优化字符串相似度评估，提高匹配准确性
- 完善包含关系处理：当输入是服务器名称的子字符串时，根据比例计算相似度
- 防止误匹配：当输入"A"同时存在"小游戏A"和"原版服A"时，不再随机匹配
- 优化超时处理：减少RCON操作超时时间至3秒，提高响应速度
- 移除重试机制：失败时立即返回结果，避免长时间等待
- 增强错误提示：优化错误信息的用户友好性，添加标识符区分错误类型
- 统一用户名更新：自动在白名单操作前更新用户名，确保使用最新名称
- 添加批处理失败率阈值：当失败率超过50%自动中止操作，防止无效请求

### v1.3.2
- 添加批量白名单功能：新增`mcid whitelist addall <服务器名称>`命令，允许管理员将所有已绑定的MC账号添加到指定服务器的白名单
- 优化批量处理流程：使用并发控制和分批处理，避免服务器过载
- 增加实时进度反馈：批量处理过程中显示进度百分比和处理状态

### v1.3.1
- 添加服务器启用/停用开关：可在配置中使用`enabled`字段控制服务器是否启用
- 优化服务器列表显示：自动过滤停用的服务器，并在列表中显示服务器状态
- 改进服务器查询逻辑：获取白名单信息时自动排除已停用的服务器

### v1.3.0
- 添加消息自动撤回功能：新增`autoRecallTime`配置，可设置机器人消息自动撤回时间
- 添加主人专用重置命令：`mcid whitelist reset <服务器名称>`可清除所有用户的指定服务器白名单记录
- 优化@前缀匹配：修复了包含特殊字符的昵称无法正确匹配的问题
- 增强正则表达式安全性：对特殊字符进行转义，防止注入攻击
- 改进前缀匹配逻辑：同时支持带@和不带@的昵称格式，增强用户体验

### v1.2.0
- 文本前缀匹配优化：修复了前缀匹配逻辑，现在严格匹配配置中的完整机器人昵称
- 安全性增强：解决了可能导致非预期命令执行的问题
- 用户体验优化：改进了命令触发方式，与Koishi框架标准行为保持一致

### v1.1.9
- 服务器配置增强：新增服务器说明字段，在服务器地址下方显示
- API 验证优化：改进备用 API 集成，确保 UUID 处理一致性
- 白名单管理：内部添加自动重试机制，提高白名单操作成功率
- RCON 日志优化：统一日志格式，使用服务器名称而非 ID

### v1.1.8
- API 验证优化：增加 User-Agent，改进错误处理与自动切换
- 用户名同步：自动检测并更新改名玩家
- 皮肤渲染：升级至 Starlight SkinAPI，支持随机姿势
- 界面优化：使用圈数字序号，精简显示格式
- 稳定性：改进 RCON 日志与错误处理

### v1.1.7
- 添加白名单显示服务器连接地址功能
- 优化服务器列表显示，使用圈数字序号
- 添加启动时API状态验证

### v1.1.6
- 优化文本前缀触发功能，支持使用 `@机器人昵称 mcid命令` 格式直接触发命令
- 修复在QQ平台@消息识别问题，改进命令执行逻辑
- 提升文本前缀匹配的可靠性和响应速度

### v1.1.5
- 增加并发安全机制，防止同一用户同时执行多次白名单操作
- 优化RCON命令响应处理，提高成功率
- 支持识别各种格式的成功响应

### v1.1.4
- 添加数据库兼容和迁移功能
- 支持从旧版本平滑升级
- 修复白名单状态更新bug